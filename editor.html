<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS Sandbox</title>
  </head>
  <body>
    <p>Write a function <code>add(a, b)</code> that returns the sum of two numbers.</p>
    <div id="container" style="width:100%;height:40vh;border:1px solid grey"></div>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.27.0/min/vs/loader.js"></script>

    <script>
      require.config({
        paths: { vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.27.0/min/vs" }
      });

      require(["vs/editor/editor.main"], function () {
        var editor = monaco.editor.create(document.getElementById("container"), {
          value: `function add(a, b) {\n  return a + b;\n}`,
          language: "javascript",
          automaticLayout: true
        });
        monaco.editor.setTheme('vs-dark');

        window.runCode = function () {
          const userCode = editor.getValue();
          const testCases = [
            { input: [2, 3], expected: 5 },
            { input: [10, 20], expected: 30 },
            { input: [-5, 5], expected: 0 }
          ];

          const outputDiv = document.getElementById("output");
          outputDiv.innerHTML = "<strong>Running Tests...</strong>\n";

          const iframe = document.createElement("iframe");
          iframe.style.display = "none";
          document.body.appendChild(iframe);

          const iframeWindow = iframe.contentWindow;
          const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;

          iframeDocument.open();
          iframeDocument.write("<html><body></body></html>");
          iframeDocument.close();

          iframe.height = iframe.contentWindow.document.body.scrollHeight + 'px';

          const script = iframeDocument.createElement("script");
          script.textContent = `
            (function() {
              try {
                ${userCode}
                function runTests() {
                    let results = [];
                    const testCases = ${JSON.stringify(testCases)};
                    for (let test of testCases) {
                        try {
                            let result = add(...test.input);
                            results.push(
                              "Expected: " + test.expected + " | " +
                              "Actual: " + result + " | " +
                              (result === test.expected ? "✅ Passed" : "❌ Failed")
                            );
                        } catch (e) {
                            results.push("❌ Error: " + e.message);
                        }
                    }
                    parent.postMessage(results, "*");
                }
                runTests();
              } catch (err) {
                parent.postMessage(["❌ Code Error: " + err.message], "*");
              }
            })();
          `;

          iframeDocument.body.appendChild(script);

          function waitForIframeContent(iframe) {
              return new Promise((resolve) => {
                  let observer = new MutationObserver(() => {
                      resolve();
                      observer.disconnect();
                  });

                  observer.observe(iframe.contentWindow.document.body, { childList: true, subtree: true });
              });
          }

          window.addEventListener("message", async function receiveMessage(event) {
            if (event.source === iframeWindow) {
              outputDiv.innerHTML = event.data.join("<br>");

               // Wait for content changes
              await waitForIframeContent(iframe);

              // Adjust height dynamically
              iframe.style.height = iframe.contentWindow.document.body.scrollHeight + "px";

              document.body.removeChild(iframe);
              window.removeEventListener("message", receiveMessage);
            }
          });
        };
      });
    </script>

    <button onclick="runCode()">Run Code</button>
    <div id="output"></div>

  </body>
</html>
